<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AreaSearch - Missing Persons Search Route Generator</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #1a1a2e;
            color: #eaeaea;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 12px 20px;
            border-bottom: 2px solid #e94560;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: #e94560;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
        }

        .subtitle {
            font-size: 0.75rem;
            color: #888;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #ff6b6b;
        }

        .btn-secondary {
            background: #16213e;
            color: #eaeaea;
            border: 1px solid #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #1f2b46;
        }

        .btn-success {
            background: #00d26a;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #00e676;
        }

        .btn-tracking {
            background: #3498db;
            color: white;
        }

        .btn-tracking.active {
            background: #e94560;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        main {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        #map {
            flex: 1;
            z-index: 1;
        }

        .sidebar {
            width: 380px;
            background: #16213e;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            z-index: 10;
            overflow: hidden;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #333;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: #1a1a2e;
            border: none;
            color: #888;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .sidebar-tab.active {
            background: #16213e;
            color: #e94560;
            border-bottom: 2px solid #e94560;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .panel {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .panel h3 {
            font-size: 0.85rem;
            color: #e94560;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #16213e;
            border-radius: 6px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #00d26a;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #888;
            margin-top: 2px;
        }

        /* Progress bar */
        .progress-container {
            margin-top: 15px;
        }

        .progress-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d26a, #00e676);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.75rem;
            color: #888;
        }

        /* Directions list */
        .directions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .direction-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #16213e;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .direction-item:hover {
            background: #1f2b46;
        }

        .direction-item.current {
            border-left-color: #3498db;
            background: #1f2b46;
        }

        .direction-item.searched {
            border-left-color: #00d26a;
            opacity: 0.7;
        }

        .direction-number {
            width: 28px;
            height: 28px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .direction-item.searched .direction-number {
            background: #00d26a;
            color: #1a1a2e;
        }

        .direction-content {
            flex: 1;
            min-width: 0;
        }

        .direction-instruction {
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: #eaeaea;
        }

        .direction-street {
            font-size: 0.75rem;
            color: #888;
        }

        .direction-distance {
            font-size: 0.75rem;
            color: #00d26a;
            text-align: right;
            flex-shrink: 0;
        }

        /* GPS status */
        .gps-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #16213e;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .gps-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }

        .gps-dot.active {
            background: #00d26a;
            animation: blink 1s infinite;
        }

        .gps-dot.error {
            background: #e94560;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .gps-text {
            font-size: 0.8rem;
            color: #888;
        }

        .instructions {
            font-size: 0.85rem;
            color: #aaa;
            line-height: 1.6;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            color: #eaeaea;
        }

        .loading-subtext {
            font-size: 0.85rem;
            color: #888;
        }

        .notification {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 8px;
            z-index: 1001;
            max-width: 350px;
            animation: slideIn 0.3s ease;
            font-size: 0.9rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success { background: #00d26a; color: white; }
        .notification.error { background: #e94560; color: white; }
        .notification.info { background: #3498db; color: white; }

        .warning-banner {
            background: #f39c12;
            color: #1a1a2e;
            padding: 6px 15px;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 500;
        }

        .coord-display {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            background: #0d0d1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* Leaflet customizations */
        .leaflet-control-zoom a {
            background: #16213e !important;
            color: #eaeaea !important;
            border: 1px solid #333 !important;
        }

        .leaflet-draw-toolbar a {
            background: #16213e !important;
            border: 1px solid #333 !important;
        }

        .user-marker {
            background: #3498db;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }

        /* Responsive */
        @media (max-width: 900px) {
            main { flex-direction: column; }
            .sidebar {
                width: 100%;
                max-height: 45vh;
                border-left: none;
                border-top: 1px solid #333;
            }
        }
    </style>
</head>
<body>
    <div class="warning-banner">
        Safety: Always search with a partner. Driver watches the road - passenger navigates.
    </div>

    <header>
        <div class="logo">
            <div class="logo-icon">AS</div>
            <div>
                <h1>AreaSearch</h1>
                <div class="subtitle">Missing Persons Search Route</div>
            </div>
        </div>
        <div class="controls">
            <button id="trackingBtn" class="btn-tracking" disabled>
                <span id="trackingIcon">&#9673;</span>
                <span id="trackingText">Start Tracking</span>
            </button>
            <button id="clearBtn" class="btn-secondary">Clear</button>
            <button id="generateBtn" class="btn-primary" disabled>Plan Route</button>
            <button id="exportBtn" class="btn-success" disabled>Export GPX</button>
        </div>
    </header>

    <main>
        <div id="map"></div>

        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="info">Info</button>
                <button class="sidebar-tab" data-tab="directions">Directions</button>
                <button class="sidebar-tab" data-tab="progress">Progress</button>
            </div>

            <div class="sidebar-content">
                <!-- Info Tab -->
                <div class="tab-panel active" id="tab-info">
                    <div class="panel">
                        <h3>Instructions</h3>
                        <div class="instructions">
                            <ol>
                                <li>Draw a <strong>rectangle</strong> or <strong>polygon</strong> on the map</li>
                                <li>Click <strong>"Plan Route"</strong> to generate the search path</li>
                                <li>Click <strong>"Start Tracking"</strong> to record your progress</li>
                                <li>Streets turn green as you drive them</li>
                            </ol>
                        </div>
                    </div>

                    <div class="panel" id="areaPanel" style="display: none;">
                        <h3>Selected Area</h3>
                        <div class="coord-display" id="coordDisplay"></div>
                    </div>

                    <div class="panel" id="statsPanel" style="display: none;">
                        <h3>Route Statistics</h3>
                        <div class="stat-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="statDistance">--</div>
                                <div class="stat-label">Distance (km)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="statStreets">--</div>
                                <div class="stat-label">Streets</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="statNodes">--</div>
                                <div class="stat-label">Intersections</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="statDuplicates">--</div>
                                <div class="stat-label">Repeats</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Directions Tab -->
                <div class="tab-panel" id="tab-directions">
                    <div class="gps-status">
                        <div class="gps-dot" id="gpsDot"></div>
                        <span class="gps-text" id="gpsStatus">GPS not active</span>
                    </div>

                    <div class="directions-list" id="directionsList">
                        <div class="panel">
                            <p style="color: #888; font-size: 0.9rem;">Generate a route to see directions</p>
                        </div>
                    </div>
                </div>

                <!-- Progress Tab -->
                <div class="tab-panel" id="tab-progress">
                    <div class="panel">
                        <h3>Search Progress</h3>
                        <div class="stat-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="searchedCount">0</div>
                                <div class="stat-label">Segments Done</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="remainingCount">0</div>
                                <div class="stat-label">Remaining</div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progressPercent">0%</span>
                                <span id="progressDistance">0 / 0 km</span>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Time Elapsed</h3>
                        <div class="stat-item" style="background: transparent;">
                            <div class="stat-value" id="timeElapsed">00:00:00</div>
                            <div class="stat-label">HH:MM:SS</div>
                        </div>
                    </div>

                    <div class="panel">
                        <button id="resetProgressBtn" class="btn-secondary" style="width: 100%;">
                            Reset Progress
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Generating Search Route...</div>
        <div class="loading-subtext" id="loadingSubtext">Downloading street network</div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        // ============================================
        // Configuration & State
        // ============================================
        const API_BASE_URL = window.location.origin;
        const SEARCH_THRESHOLD_METERS = 30; // Distance threshold for marking segment as searched

        let map, drawnItems, routeLayer, segmentsLayer, userMarker;
        let currentBounds = null;
        let currentRoute = null;
        let segments = [];
        let directions = [];

        // GPS Tracking State
        let isTracking = false;
        let watchId = null;
        let userPosition = null;
        let searchStartTime = null;
        let timerInterval = null;

        // ============================================
        // Initialize Map
        // ============================================
        function initMap() {
            map = L.map('map', {
                center: [40.7128, -74.0060],
                zoom: 14
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                maxZoom: 20
            }).addTo(map);

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            routeLayer = new L.FeatureGroup();
            map.addLayer(routeLayer);

            segmentsLayer = new L.FeatureGroup();
            map.addLayer(segmentsLayer);

            // Drawing controls
            const drawControl = new L.Control.Draw({
                position: 'topleft',
                draw: {
                    polyline: false,
                    circle: false,
                    circlemarker: false,
                    marker: false,
                    polygon: {
                        allowIntersection: false,
                        shapeOptions: { color: '#e94560', fillColor: '#e94560', fillOpacity: 0.2, weight: 2 }
                    },
                    rectangle: {
                        shapeOptions: { color: '#e94560', fillColor: '#e94560', fillOpacity: 0.2, weight: 2 }
                    }
                },
                edit: { featureGroup: drawnItems, remove: true }
            });
            map.addControl(drawControl);

            // Drawing events
            map.on(L.Draw.Event.CREATED, handleDrawCreated);
            map.on(L.Draw.Event.DELETED, handleDrawDeleted);

            // Geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        map.setView([pos.coords.latitude, pos.coords.longitude], 15);
                        showNotification('Map centered on your location', 'info');
                    },
                    err => console.log('Geolocation error:', err)
                );
            }
        }

        // ============================================
        // Drawing Handlers
        // ============================================
        function handleDrawCreated(event) {
            const layer = event.layer;
            drawnItems.clearLayers();
            routeLayer.clearLayers();
            segmentsLayer.clearLayers();
            currentRoute = null;
            segments = [];
            directions = [];

            drawnItems.addLayer(layer);

            const bounds = layer.getBounds();
            currentBounds = {
                north: bounds.getNorth(),
                south: bounds.getSouth(),
                east: bounds.getEast(),
                west: bounds.getWest()
            };

            const areaType = event.layerType === 'polygon' ? 'Polygon' : 'Rectangle';
            updateCoordDisplay(`${areaType} Area:\nN: ${currentBounds.north.toFixed(6)}\nS: ${currentBounds.south.toFixed(6)}\nE: ${currentBounds.east.toFixed(6)}\nW: ${currentBounds.west.toFixed(6)}`);

            document.getElementById('generateBtn').disabled = false;
            document.getElementById('areaPanel').style.display = 'block';
            document.getElementById('statsPanel').style.display = 'none';
            document.getElementById('trackingBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            updateDirectionsList();
        }

        function handleDrawDeleted() {
            currentBounds = null;
            currentRoute = null;
            segments = [];
            directions = [];
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('trackingBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('areaPanel').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'none';
            routeLayer.clearLayers();
            segmentsLayer.clearLayers();
            updateDirectionsList();
            resetProgress();
        }

        // ============================================
        // Route Generation
        // ============================================
        async function generateRoute() {
            if (!currentBounds) {
                showNotification('Please draw a search area first', 'error');
                return;
            }

            setLoading(true, 'Downloading street network...');

            try {
                const response = await fetch(`${API_BASE_URL}/generate-route`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bbox: currentBounds })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.detail || 'Failed to generate route');
                if (!data.success) throw new Error(data.message || 'Route generation failed');

                currentRoute = data;
                segments = data.segments || [];
                directions = data.directions || [];

                displayRoute(data);
                displaySegments();
                updateStatistics(data);
                updateDirectionsList();
                updateProgress();

                document.getElementById('trackingBtn').disabled = false;
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('statsPanel').style.display = 'block';

                showNotification(`Route ready! ${data.total_distance_km} km, ${data.num_streets} streets`, 'success');
                switchTab('directions');

            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // ============================================
        // Display Functions
        // ============================================
        function displayRoute(data) {
            routeLayer.clearLayers();
            if (!data.route || data.route.length === 0) return;

            const latlngs = data.route.map(c => [c[1], c[0]]);

            // Main route line (dimmed)
            L.polyline(latlngs, {
                color: '#666',
                weight: 3,
                opacity: 0.5
            }).addTo(routeLayer);

            // Start/End markers
            const startIcon = L.divIcon({
                html: '<div style="background:#00d26a;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;font-size:12px;">S</div>',
                className: '',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });
            const endIcon = L.divIcon({
                html: '<div style="background:#e94560;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;font-size:12px;">E</div>',
                className: '',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            L.marker(latlngs[0], { icon: startIcon }).addTo(routeLayer);
            L.marker(latlngs[latlngs.length - 1], { icon: endIcon }).addTo(routeLayer);

            map.fitBounds(L.polyline(latlngs).getBounds(), { padding: [50, 50] });
        }

        function displaySegments() {
            segmentsLayer.clearLayers();

            segments.forEach((seg, idx) => {
                const latlngs = seg.coordinates.map(c => [c[1], c[0]]);
                const color = seg.searched ? '#00d26a' : '#e94560';

                const line = L.polyline(latlngs, {
                    color: color,
                    weight: 5,
                    opacity: 0.8
                });

                line.segmentId = seg.id;
                line.on('click', () => highlightDirection(idx));
                segmentsLayer.addLayer(line);
            });
        }

        function updateSegmentColor(segmentId, searched) {
            segmentsLayer.eachLayer(layer => {
                if (layer.segmentId === segmentId) {
                    layer.setStyle({ color: searched ? '#00d26a' : '#e94560' });
                }
            });
        }

        // ============================================
        // Directions
        // ============================================
        function updateDirectionsList() {
            const container = document.getElementById('directionsList');

            if (!directions || directions.length === 0) {
                container.innerHTML = '<div class="panel"><p style="color:#888;font-size:0.9rem;">Generate a route to see directions</p></div>';
                return;
            }

            let html = '';
            directions.forEach((dir, idx) => {
                const searched = isDirectionSearched(idx);
                const distance = dir.distance_m >= 1000
                    ? (dir.distance_m / 1000).toFixed(1) + ' km'
                    : Math.round(dir.distance_m) + ' m';

                html += `
                    <div class="direction-item ${searched ? 'searched' : ''}" data-idx="${idx}" onclick="focusDirection(${idx})">
                        <div class="direction-number">${idx + 1}</div>
                        <div class="direction-content">
                            <div class="direction-instruction">${dir.instruction}</div>
                            <div class="direction-street">${dir.street_name}</div>
                        </div>
                        <div class="direction-distance">${distance}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function isDirectionSearched(dirIdx) {
            // A direction is searched if its first segment is searched
            const dir = directions[dirIdx];
            if (!dir) return false;
            const seg = segments.find(s => s.id === dir.segment_id);
            return seg ? seg.searched : false;
        }

        function focusDirection(idx) {
            const dir = directions[idx];
            if (!dir || !dir.coordinates || dir.coordinates.length === 0) return;

            const latlngs = dir.coordinates.map(c => [c[1], c[0]]);
            map.fitBounds(L.polyline(latlngs).getBounds(), { padding: [100, 100], maxZoom: 17 });

            highlightDirection(idx);
        }

        function highlightDirection(idx) {
            document.querySelectorAll('.direction-item').forEach((el, i) => {
                el.classList.toggle('current', i === idx);
            });
        }

        // ============================================
        // GPS Tracking
        // ============================================
        function toggleTracking() {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        }

        function startTracking() {
            if (!navigator.geolocation) {
                showNotification('Geolocation not supported', 'error');
                return;
            }

            isTracking = true;
            searchStartTime = searchStartTime || Date.now();
            startTimer();

            document.getElementById('trackingBtn').classList.add('active');
            document.getElementById('trackingText').textContent = 'Stop Tracking';
            document.getElementById('gpsDot').classList.add('active');
            document.getElementById('gpsStatus').textContent = 'Acquiring GPS...';

            watchId = navigator.geolocation.watchPosition(
                handlePositionUpdate,
                handlePositionError,
                { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
            );

            showNotification('GPS tracking started', 'success');
        }

        function stopTracking() {
            isTracking = false;

            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            stopTimer();

            document.getElementById('trackingBtn').classList.remove('active');
            document.getElementById('trackingText').textContent = 'Start Tracking';
            document.getElementById('gpsDot').classList.remove('active');
            document.getElementById('gpsStatus').textContent = 'GPS paused';

            showNotification('GPS tracking paused', 'info');
        }

        function handlePositionUpdate(position) {
            const { latitude, longitude, accuracy } = position.coords;
            userPosition = { lat: latitude, lng: longitude };

            document.getElementById('gpsStatus').textContent = `GPS active (Â±${Math.round(accuracy)}m)`;

            // Update user marker
            if (userMarker) {
                userMarker.setLatLng([latitude, longitude]);
            } else {
                const userIcon = L.divIcon({
                    html: '<div class="user-marker" style="width:16px;height:16px;"></div>',
                    className: '',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                userMarker = L.marker([latitude, longitude], { icon: userIcon, zIndexOffset: 1000 }).addTo(map);
            }

            // Check proximity to segments
            checkSegmentProximity(latitude, longitude);
        }

        function handlePositionError(error) {
            console.error('GPS Error:', error);
            document.getElementById('gpsDot').classList.add('error');
            document.getElementById('gpsDot').classList.remove('active');
            document.getElementById('gpsStatus').textContent = 'GPS error: ' + error.message;
        }

        function checkSegmentProximity(lat, lng) {
            let updated = false;

            segments.forEach(seg => {
                if (seg.searched) return;

                // Check distance to segment
                const minDist = minDistanceToSegment(lat, lng, seg.coordinates);
                if (minDist <= SEARCH_THRESHOLD_METERS) {
                    seg.searched = true;
                    updateSegmentColor(seg.id, true);
                    updated = true;
                }
            });

            if (updated) {
                updateProgress();
                updateDirectionsList();
            }
        }

        function minDistanceToSegment(lat, lng, coords) {
            let minDist = Infinity;

            for (let i = 0; i < coords.length - 1; i++) {
                const dist = distanceToLineSegment(
                    lat, lng,
                    coords[i][1], coords[i][0],
                    coords[i + 1][1], coords[i + 1][0]
                );
                minDist = Math.min(minDist, dist);
            }

            return minDist;
        }

        function distanceToLineSegment(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;

            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = lenSq !== 0 ? dot / lenSq : -1;

            let xx, yy;
            if (param < 0) {
                xx = x1; yy = y1;
            } else if (param > 1) {
                xx = x2; yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }

            return haversineDistance(px, py, xx, yy);
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // ============================================
        // Progress & Timer
        // ============================================
        function updateProgress() {
            const total = segments.length;
            const searched = segments.filter(s => s.searched).length;
            const remaining = total - searched;
            const percent = total > 0 ? Math.round((searched / total) * 100) : 0;

            const totalDist = segments.reduce((sum, s) => sum + s.distance_m, 0) / 1000;
            const searchedDist = segments.filter(s => s.searched).reduce((sum, s) => sum + s.distance_m, 0) / 1000;

            document.getElementById('searchedCount').textContent = searched;
            document.getElementById('remainingCount').textContent = remaining;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressDistance').textContent = `${searchedDist.toFixed(1)} / ${totalDist.toFixed(1)} km`;

            if (searched === total && total > 0) {
                showNotification('Search complete! All streets covered.', 'success');
                stopTracking();
            }
        }

        function resetProgress() {
            segments.forEach(s => s.searched = false);
            searchStartTime = null;
            stopTimer();
            document.getElementById('timeElapsed').textContent = '00:00:00';
            displaySegments();
            updateProgress();
            updateDirectionsList();
        }

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimer() {
            if (!searchStartTime) return;
            const elapsed = Math.floor((Date.now() - searchStartTime) / 1000);
            const hrs = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const mins = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('timeElapsed').textContent = `${hrs}:${mins}:${secs}`;
        }

        // ============================================
        // UI Helpers
        // ============================================
        function updateCoordDisplay(text) {
            document.getElementById('coordDisplay').textContent = text;
        }

        function updateStatistics(data) {
            document.getElementById('statDistance').textContent = data.total_distance_km || '--';
            document.getElementById('statStreets').textContent = data.num_streets || '--';
            document.getElementById('statNodes').textContent = data.num_nodes || '--';
            document.getElementById('statDuplicates').textContent = data.duplicated_edges || '0';
        }

        function showNotification(message, type = 'info') {
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.textContent = message;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 4000);
        }

        function setLoading(loading, message = '') {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingSubtext').textContent = message;
            overlay.classList.toggle('active', loading);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + tabId));
        }

        function clearAll() {
            drawnItems.clearLayers();
            routeLayer.clearLayers();
            segmentsLayer.clearLayers();
            if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
            currentBounds = null;
            currentRoute = null;
            segments = [];
            directions = [];
            stopTracking();
            resetProgress();
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('trackingBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('areaPanel').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'none';
            updateDirectionsList();
            showNotification('Cleared', 'info');
        }

        function exportGPX() {
            if (!currentRoute || !currentRoute.route) {
                showNotification('No route to export', 'error');
                return;
            }

            const route = currentRoute.route;
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="AreaSearch">
  <metadata>
    <name>AreaSearch Route</name>
    <desc>Distance: ${currentRoute.total_distance_km} km, Streets: ${currentRoute.num_streets}</desc>
    <time>${new Date().toISOString()}</time>
  </metadata>
  <trk>
    <name>Search Route</name>
    <trkseg>
`;
            route.forEach(c => { gpx += `      <trkpt lat="${c[1]}" lon="${c[0]}"></trkpt>\n`; });
            gpx += `    </trkseg>\n  </trk>\n</gpx>`;

            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `areasearch_${new Date().toISOString().slice(0, 10)}.gpx`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('GPX exported', 'success');
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();

            document.getElementById('generateBtn').addEventListener('click', generateRoute);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            document.getElementById('exportBtn').addEventListener('click', exportGPX);
            document.getElementById('trackingBtn').addEventListener('click', toggleTracking);
            document.getElementById('resetProgressBtn').addEventListener('click', resetProgress);

            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
        });
    </script>
</body>
</html>
